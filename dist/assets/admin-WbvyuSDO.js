import"./style-HOslubru.js";import{initializeApp as qt}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as Gt,onAuthStateChanged as Ft,signInWithEmailAndPassword as Jt,signOut as zt}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getFirestore as Kt,query as Yt,collection as B,orderBy as Vt,getDocs as K,updateDoc as E,doc as g,deleteDoc as Xt,writeBatch as _,getDoc as nt}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{getStorage as Wt,ref as Zt,uploadBytes as Qt,getDownloadURL as te}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";import{f as ee}from"./firebase-config-D0anIP3T.js";const at=qt(ee),st=Gt(at),d=Kt(at),ne=Wt(at),ct=document.getElementById("login-view"),rt=document.getElementById("admin-panel"),ae=document.getElementById("logout-btn"),se=document.querySelector(".tabs"),oe=document.querySelectorAll(".tab-link"),ce=document.querySelectorAll(".tab-content"),N=document.getElementById("file-drop-area"),it=document.getElementById("file-input"),T=document.getElementById("file-name-display"),re=document.getElementById("upload-btn"),k=document.getElementById("upload-status"),P=document.getElementById("data-table-container"),ie=document.getElementById("data-search-input"),le=document.getElementById("bulk-delete-btn"),lt=document.getElementById("run-analysis-selected-btn"),dt=document.getElementById("run-analysis-all-btn"),L=document.getElementById("analysis-status"),x=document.getElementById("comments-analysis-status"),ut=document.getElementById("run-comments-selected-btn"),Z=document.getElementById("comment-count-input"),mt=document.getElementById("analysis-banner"),Y=document.getElementById("analysis-banner-text"),V=document.getElementById("analysis-progress-bar"),D=document.getElementById("analysis-log"),Ct=document.getElementById("edit-modal"),Q=document.getElementById("edit-form"),de=document.getElementById("save-edit-btn"),ue=document.getElementById("cancel-edit-btn"),me=document.getElementById("close-edit-modal-btn"),xt=document.getElementById("confirm-modal"),ht=document.getElementById("confirm-modal-title"),gt=document.getElementById("confirm-modal-message"),he=document.getElementById("confirm-delete-btn"),ge=document.getElementById("cancel-delete-btn");let q=[],tt=null,At=null,It=!1,A=null;Ft(st,t=>{t?(ct.classList.add("hidden"),rt.classList.remove("hidden"),R()):(ct.classList.remove("hidden"),rt.classList.add("hidden"))});document.getElementById("login-form").addEventListener("submit",t=>{t.preventDefault();const e=document.getElementById("email").value,n=document.getElementById("password").value;console.log("로그인 시도 이메일:",e),Jt(st,e,n).then(s=>{console.log("로그인 성공!",s.user)}).catch(s=>{console.error("Firebase에서 받은 실제 에러:",s),document.getElementById("login-error").textContent="이메일 또는 비밀번호가 잘못되었습니다."})});ae.addEventListener("click",()=>zt(st));se.addEventListener("click",t=>{if(t.target.classList.contains("tab-link")){const e=t.target.getAttribute("data-tab");oe.forEach(n=>n.classList.remove("active")),ce.forEach(n=>n.classList.remove("active")),t.target.classList.add("active"),document.getElementById(e).classList.add("active")}});const R=async()=>{P.innerHTML='<p class="info-message">데이터를 불러오는 중...</p>';try{const t=Yt(B(d,"videos"),Vt("date","desc"));q=(await K(t)).docs.map(n=>({id:n.id,...n.data()})),Bt(q)}catch(t){console.error("Error fetching data: ",t),P.innerHTML='<p class="error-message">데이터를 불러오는 데 실패했습니다.</p>'}},Bt=t=>{if(t.length===0){P.innerHTML='<p class="info-message">표시할 데이터가 없습니다.</p>';return}const e=document.createElement("table");e.className="data-table",e.innerHTML=`
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all-checkbox"></th>
                <th>썸네일</th><th>제목</th><th>채널</th><th>게시일</th><th>상태</th><th>관리</th>
            </tr>
        </thead>
        <tbody>
            ${t.map(n=>`
                <tr data-id="${n.id}">
                    <td><input type="checkbox" class="row-checkbox" data-id="${n.id}"></td>
                    <td><img src="${n.thumbnail}" alt="thumbnail" class="table-thumbnail"/></td>
                    <td class="table-title">${n.title}</td>
                    <td>${n.channel}</td>
                    <td>${n.date}</td>
                    <td>${Array.isArray(n.dopamine_graph)&&n.dopamine_graph.length?'<span class="group-tag" style="background:#10b981;">Graph</span>':""}</td>
                    <td class="action-buttons">
                        <button class="btn btn-edit" data-id="${n.id}">수정</button>
                        <button class="btn btn-danger single-delete-btn" data-id="${n.id}">삭제</button>
                    </td>
                </tr>
            `).join("")}
        </tbody>
    `,P.innerHTML="",P.appendChild(e),document.getElementById("select-all-checkbox").addEventListener("change",n=>{document.querySelectorAll(".row-checkbox").forEach(s=>{s.checked=n.target.checked})})};ie.addEventListener("input",t=>{const e=t.target.value.toLowerCase(),n=q.filter(s=>s.title&&s.title.toLowerCase().includes(e)||s.channel&&s.channel.toLowerCase().includes(e));Bt(n)});const ye=async t=>{tt=t;const e=g(d,"videos",tt),n=await nt(e);if(n.exists()){const s=n.data();Q.innerHTML="",Object.keys(s).sort().forEach(a=>{const r=s[a],o=r&&typeof r=="object",i=o?JSON.stringify(r,null,2):r??"",l=String(i).length>100||o;Q.innerHTML+=`
                <div class="form-group">
                    <label for="edit-${a}">${a}</label>
                    ${l?`<textarea id="edit-${a}" name="${a}" style="min-height:120px;">${i}</textarea>`:`<input type="text" id="edit-${a}" name="${a}" value="${i}">`}
                </div>
            `}),Ct.classList.remove("hidden")}},ot=()=>Ct.classList.add("hidden");de.addEventListener("click",async()=>{const t={};new FormData(Q).forEach((e,n)=>{try{/^\s*\[|\{/.test(String(e))?t[n]=JSON.parse(e):t[n]=e}catch{t[n]=e}}),await E(g(d,"videos",tt),t),ot(),R()});ue.addEventListener("click",ot);me.addEventListener("click",ot);const Lt=(t,e=!1)=>{It=e,e?(ht.textContent="선택 삭제 확인",gt.textContent="선택된 항목들을 정말로 삭제하시겠습니까?"):(At=t,ht.textContent="삭제 확인",gt.textContent="정말로 삭제하시겠습니까?"),xt.classList.remove("hidden")},Tt=()=>xt.classList.add("hidden");he.addEventListener("click",async()=>{if(It){const t=Array.from(document.querySelectorAll(".row-checkbox:checked")).map(n=>n.dataset.id),e=_(d);t.forEach(n=>{e.delete(g(d,"videos",n))}),await e.commit()}else await Xt(g(d,"videos",At));Tt(),R()});ge.addEventListener("click",Tt);P.addEventListener("click",t=>{t.target.matches(".btn-edit")&&ye(t.target.dataset.id),t.target.matches(".single-delete-btn")&&Lt(t.target.dataset.id,!1)});le.addEventListener("click",()=>{Array.from(document.querySelectorAll(".row-checkbox:checked")).length>0?Lt(null,!0):alert("삭제할 항목을 선택해주세요.")});const Dt="gemini_api_key_secure",Mt="transcript_server_url",X=document.getElementById("gemini-api-key"),yt=document.getElementById("save-gemini-key-btn"),pt=document.getElementById("test-gemini-key-btn"),M=document.getElementById("gemini-key-status"),et=document.getElementById("transcript-server-url"),ft=document.getElementById("save-transcript-server-btn"),F=document.getElementById("transcript-server-status"),bt=document.getElementById("schedule-create-btn"),wt=document.getElementById("schedule-ranking-btn"),kt=document.getElementById("ranking-refresh-now-btn"),p=document.getElementById("schedule-create-status"),j=document.getElementById("schedules-table-container"),Et=document.getElementById("schedules-bulk-delete-btn"),S=document.getElementById("schedule-time"),J=document.getElementById("schedule-log"),$=document.getElementById("youtube-api-keys"),vt=document.getElementById("save-youtube-keys-btn"),St=document.getElementById("test-youtube-keys-btn"),I=document.getElementById("youtube-keys-status");function G(){try{return localStorage.getItem(Dt)||""}catch{return""}}function pe(t){try{localStorage.setItem(Dt,t||"")}catch{}}function Pt(){try{return localStorage.getItem(Mt)||"/api"}catch{return"/api"}}function fe(t){try{localStorage.setItem(Mt,t||"/api")}catch{}}window.addEventListener("DOMContentLoaded",()=>{const t=G();X&&t&&(X.value=t);const e=Pt();et&&(et.value=e);try{const n=localStorage.getItem("youtube_api_keys_list")||"";$&&($.value=n)}catch{}if(S){const n=new Date;n.setMinutes(n.getMinutes()+30),S.value=be(n)}});yt&&yt.addEventListener("click",()=>{const t=X.value.trim();if(!t){M.textContent="키를 입력하세요.";return}pe(t),M.textContent="Gemini API 키 저장 완료."});pt&&pt.addEventListener("click",async()=>{const t=X.value.trim()||G();if(!t){M.textContent="키가 없습니다.";return}M.textContent="테스트 중...";try{const e=await fetch("https://generativelanguage.googleapis.com/v1/models?key="+encodeURIComponent(t));if(!e.ok)throw new Error("HTTP "+e.status);M.textContent="키 통신 성공 (권한은 별도 확인 필요)"}catch(e){M.textContent="키 테스트 실패: "+e.message}});ft&&ft.addEventListener("click",async()=>{const t=(et.value||"").trim();if(!t){F.textContent="서버 주소를 입력하세요.";return}fe(t),F.textContent="서버 주소 저장 완료. 상태 확인 중...";try{const e=t.replace(/\/$/,"")+"/health",n=await fetch(e);F.textContent=n.ok?"서버 온라인":"서버 응답 오류"}catch(e){F.textContent="서버 연결 실패: "+e.message}});function be(t){const e=i=>String(i).padStart(2,"0"),n=t.getFullYear(),s=e(t.getMonth()+1),a=e(t.getDate()),r=e(t.getHours()),o=e(t.getMinutes());return`${n}-${s}-${a}T${r}:${o}`}function we(){return Array.from(document.querySelectorAll(".row-checkbox:checked")).map(t=>t.dataset.id)}async function ke(t,e,n){var i;const s=B(d,"schedules"),a=((i=document.querySelector('input[name="schedule-type"]:checked'))==null?void 0:i.value)||"analysis",r={scope:t,ids:t==="selected"?e:[],runAt:n,type:a==="ranking"?"ranking":"analysis",status:"pending",createdAt:Date.now(),updatedAt:Date.now()},o=g(s);return await E(o,r).catch(async l=>{const c=_(d);c.set(o,r),await c.commit()}),o.id}async function Nt(){const t=B(d,"schedules");return(await K(t)).docs.map(n=>({id:n.id,...n.data()}))}async function Ee(t){await E(g(d,"schedules",t),{status:"canceled",updatedAt:Date.now()})}function ve(t){if(!j)return;if(!t.length){j.innerHTML='<p class="info-message">예약이 없습니다.</p>';return}const e=`
    <table class="data-table">
        <thead><tr><th><input type="checkbox" id="sched-select-all"></th><th>ID</th><th>작업</th><th>대상</th><th>실행 시각</th><th>상태</th><th>관리</th></tr></thead>
        <tbody>
            ${t.map(s=>`
            <tr data-id="${s.id}">
                <td><input type="checkbox" class="sched-row" data-id="${s.id}"></td>
                <td>${s.id}</td>
                <td>${s.type==="ranking"?"랭킹":"분석"}</td>
                <td>${s.scope==="all"?"전체":`선택(${(s.ids||[]).length})`}</td>
                <td>${new Date(s.runAt).toLocaleString()}</td>
                <td>${s.status}</td>
                <td>
                    ${s.status==="pending"?`<button class="btn btn-danger btn-cancel-schedule" data-id="${s.id}">취소</button>`:""}
                </td>
            </tr>`).join("")}
        </tbody>
    </table>`;j.innerHTML=e;const n=document.getElementById("sched-select-all");n&&n.addEventListener("change",s=>{document.querySelectorAll(".sched-row").forEach(a=>{a.checked=s.target.checked})})}async function O(){const t=await Nt();ve(t.sort((e,n)=>e.runAt-n.runAt))}bt&&bt.addEventListener("click",async()=>{var a;const t=((a=document.querySelector('input[name="schedule-scope"]:checked'))==null?void 0:a.value)||"selected",e=(S==null?void 0:S.value)||"";if(!e){p.textContent="실행 시각을 선택하세요.";return}const n=new Date(e).getTime();if(!isFinite(n)||n<Date.now()+3e4){p.textContent="현재 시각 + 30초 이후로 설정하세요.";return}let s=[];if(t==="selected"&&(s=we(),!s.length)){p.textContent="선택 항목이 없습니다.";return}p.textContent="예약 등록 중...";try{const r=await ke(t,s,n);p.textContent=`예약 등록 완료: ${r}`,await O()}catch(r){p.textContent="예약 등록 실패: "+(r.message||r)}});wt&&wt.addEventListener("click",async()=>{if(!(S!=null&&S.value)){p.textContent="실행 시각을 선택하세요.";return}const t=new Date(S.value).getTime();if(!isFinite(t)||t<Date.now()+3e4){p.textContent="현재 시각 + 30초 이후로 설정하세요.";return}p.textContent="랭킹 예약 등록 중...";try{const e=B(d,"schedules"),n={scope:"all",ids:[],runAt:t,type:"ranking",status:"pending",createdAt:Date.now(),updatedAt:Date.now()},s=g(e),a=_(d);a.set(s,n),await a.commit(),p.textContent=`랭킹 예약 완료: ${s.id}`,await O()}catch(e){p.textContent="등록 실패: "+(e.message||e)}});vt&&vt.addEventListener("click",async()=>{const t=(($==null?void 0:$.value)||"").trim();try{localStorage.setItem("youtube_api_keys_list",t)}catch{}I.textContent="저장되었습니다. 서버에 동기화 중...";try{const e=g(d,"system","settings");await E(e,{youtube_api_keys:t,updatedAt:Date.now()}).catch(async()=>{const n=_(d);n.set(e,{youtube_api_keys:t,updatedAt:Date.now()},{merge:!0}),await n.commit()}),I.textContent="서버 저장 완료. (서버리스 갱신에 사용됩니다)"}catch(e){I.textContent="서버 저장 실패: "+(e.message||e)}});St&&St.addEventListener("click",async()=>{I.textContent="테스트 중...";const t=(($==null?void 0:$.value)||"").split(/\r?\n/).map(e=>e.trim()).filter(Boolean);if(!t.length){I.textContent="키를 입력하세요.";return}try{const e=t[0],n="https://www.googleapis.com/youtube/v3/videos?part=statistics&id=dQw4w9WgXcQ&key="+encodeURIComponent(e),s=await fetch(n);I.textContent=s.ok?"키 통신 성공 (권한은 별도 확인 필요)":"HTTP "+s.status}catch(e){I.textContent="테스트 실패: "+(e.message||e)}});kt&&kt.addEventListener("click",async()=>{p.textContent="즉시 갱신 요청 생성 중... (서버리스 호출 대기)";try{const t=B(d,"schedules"),e={scope:"all",ids:[],runAt:Date.now(),type:"ranking",status:"pending",createdAt:Date.now(),updatedAt:Date.now()},n=g(t),s=_(d);s.set(n,e),await s.commit(),p.textContent=`즉시 갱신 요청 생성 완료: ${n.id}`,await O();try{w(`랭킹 작업 전송 [${n.id}] — 서버리스 호출 시도`);const a=await fetch("/api/cron_analyze");w(`서버리스 응답 [${n.id}] ${a.ok?"OK":"HTTP "+a.status}`)}catch(a){w(`서버리스 호출 실패 [${n.id}] ${(a==null?void 0:a.message)||a}`)}}catch(t){p.textContent="생성 실패: "+(t.message||t)}});j&&j.addEventListener("click",async t=>{const e=t.target.closest(".btn-cancel-schedule");if(e){const n=e.getAttribute("data-id");await Ee(n),await O()}});Et&&Et.addEventListener("click",async()=>{const t=Array.from(document.querySelectorAll(".sched-row:checked")).map(n=>n.getAttribute("data-id"));if(!t.length){alert("삭제할 예약을 선택하세요.");return}const e=_(d);t.forEach(n=>e.delete(g(d,"schedules",n))),await e.commit(),await O()});let $t=null;async function Se(){try{const t=await Nt(),e=Date.now(),n=t.filter(a=>a.type==="ranking"&&(a.status==="pending"||a.status==="running")&&a.runAt<=e+1e3);if(n.length)try{w(`랭킹 예약 감지 (${n.length}건) — 서버리스 호출`);const a=await fetch("/api/cron_analyze");w(`서버리스 응답 ${a.ok?"OK":"HTTP "+a.status}`)}catch(a){w(`서버리스 호출 실패 ${(a==null?void 0:a.message)||a}`)}const s=t.filter(a=>a.type!=="ranking"&&a.status==="pending"&&a.runAt<=e+1e3);for(const a of s){if(a.type==="ranking"){w(`랭킹 작업 감지 [${a.id}] — 서버리스 처리 대기`);continue}await E(g(d,"schedules",a.id),{status:"running",updatedAt:Date.now()}).catch(()=>{}),w(`작업 시작 [${a.id}] (분석)`);try{if(a.scope==="all"){const r=q.map(o=>o.id);r.length&&await W(r)}else{const r=Array.isArray(a.ids)?a.ids:[];r.length&&await W(r)}await E(g(d,"schedules",a.id),{status:"done",updatedAt:Date.now()}).catch(()=>{}),w(`작업 완료 [${a.id}]`)}catch(r){await E(g(d,"schedules",a.id),{status:"canceled",error:String((r==null?void 0:r.message)||r),updatedAt:Date.now()}).catch(()=>{}),w(`작업 실패 [${a.id}] ${(r==null?void 0:r.message)||r}`)}}}catch{}}function Rt(){$t||($t=setInterval(Se,1e4))}document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(Rt(),O())});document.visibilityState==="visible"&&Rt();async function $e(t){const e=Pt(),n=await fetch(e.replace(/\/$/,"")+"/transcript?url="+encodeURIComponent(t)+"&lang=ko,en");if(!n.ok)throw new Error("Transcript fetch failed: "+n.status);return(await n.json()).text||""}function _e(){return'다음 "문장 배열"에 대해, 각 문장별로 궁금증/도파민 유발 정도를 1~10 정수로 평가하고, 그 이유를 간단히 설명하세요. 반드시 JSON 배열로만, 요소는 {"sentence":"문장","level":정수,"reason":"이유"} 형태로 출력하세요. 여는 대괄호부터 닫는 대괄호까지 외 텍스트는 출력하지 마세요.'}function Ce(t){return _e()+`

문장 배열:
`+JSON.stringify(t)}function xe(t){if(!t)return[];let e=String(t).replace(/\r/g,`
`).replace(/\n{2,}/g,`
`).trim();return e=e.replace(/>{2,}/g," ").replace(/\s{2,}/g," ").trim(),e.split(`
`).map(a=>a.trim()).filter(a=>a&&!/^\d+(\.\d+)?$/.test(a)).map(a=>a).join(`
`).replace(/([\.\?\!…])\s*\n+/g,"$1__SENT_BR__").replace(/\n+/g," ").replace(/__SENT_BR__/g," ").replace(/\s{2,}/g," ").trim().split(new RegExp("(?<=[\\.\\?\\!…])\\s+")).map(a=>a.trim()).filter(Boolean)}async function Ae(t,e){const s=[];let a=0;for(let r=0;r<t.length;r+=30){a++;const o=t.slice(r,r+30);e&&e(`도파민 분석 배치 ${a} (${r+1}~${Math.min(r+o.length,t.length)}/${t.length})`);const i=await Ut(Ce(o),"");let l=[];try{l=JSON.parse(i)}catch{const c=i.match(/\[([\s\S]*?)\]/);if(c)try{l=JSON.parse("["+c[1]+"]")}catch{}}if(Array.isArray(l))for(const c of l){const u=(c.sentence||c.text||"").toString(),y=Number(c.level??c.score??0),v=isFinite(y)?Math.max(1,Math.min(10,Math.round(y))):1,f=(c.reason||c.why||"").toString();u&&s.push({sentence:u,level:v,reason:f})}}return s}function Ot(t){mt&&mt.classList.remove("hidden"),Y&&(Y.textContent=t||""),V&&(V.style.width="0%"),D&&(D.textContent="")}function z(t,e,n){const s=e>0?Math.round(t/e*100):0;V&&(V.style.width=s+"%"),Y&&(Y.textContent=`진행률 ${t}/${e} (${s}%)`+(n?` — ${n}`:""))}function h(t){if(!D)return;const e=new Date().toLocaleTimeString();D.textContent+=`[${e}] ${t}
`,D.scrollTop=D.scrollHeight}function w(t){if(!J)return;const e=new Date().toLocaleTimeString();J.textContent+=`[${e}] ${t}
`,J.scrollTop=J.scrollHeight}async function Ut(t,e){var i,l,c,u,y;const n=G();if(!n)throw new Error("Gemini API 키가 설정되지 않았습니다.");const a=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${encodeURIComponent(n)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:t+`

`+e}]}],generationConfig:{temperature:.3}})});if(!a.ok)throw new Error("Gemini 호출 실패: "+a.status);const r=await a.json();return((y=(u=(c=(l=(i=r==null?void 0:r.candidates)==null?void 0:i[0])==null?void 0:l.content)==null?void 0:c.parts)==null?void 0:u[0])==null?void 0:y.text)||""}async function Ie(t){const e=G();if(!e)throw new Error("Gemini API 키가 설정되지 않았습니다.");const n=await fetch("https://generativelanguage.googleapis.com/v1beta/cachedContents?key="+encodeURIComponent(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"models/gemini-1.5-pro-001",contents:[{role:"user",parts:[{text:t}]}],ttl:"3600s"})});if(!n.ok)throw new Error("Cache 생성 실패: "+n.status);return await n.json()}async function Be(t,e){var o,i,l,c,u;const n=G();if(!n)throw new Error("Gemini API 키가 설정되지 않았습니다.");const s=`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${encodeURIComponent(n)}`,a=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cachedContent:t,contents:[{role:"user",parts:[{text:e}]}],generationConfig:{temperature:.2}})});if(!a.ok)throw new Error("Gemini (cache) 실패: "+a.status);const r=await a.json();return((u=(c=(l=(i=(o=r==null?void 0:r.candidates)==null?void 0:o[0])==null?void 0:i.content)==null?void 0:l.parts)==null?void 0:c[0])==null?void 0:u.text)||""}async function Le(t){const e=t.youtube_url;if(!e)throw new Error("YouTube URL 없음");h(`(${t.id}) 자막 추출 시작`);const n=await $e(e);h(`(${t.id}) 자막 길이 ${n.length}자`),h(`(${t.id}) 자막 미리보기: ${n.slice(0,120).replace(/\n/g," ")}${n.length>120?"...":""}`);const s=xe(n);if(h(`(${t.id}) 문장 분해 ${s.length}개`),t.analysis_full&&Array.isArray(t.keywords_ko)&&t.keywords_ko.length)return h(`(${t.id}) 이미 분석됨 — 통합 호출 스킵`),{updated:{...t}};h(`(${t.id}) 컨텍스트 캐시 생성`);let a="";try{const m=await Ie(n);a=(m==null?void 0:m.name)||""}catch(m){h(`(${t.id}) 캐시 실패 — 일반 호출로 진행 (${(m==null?void 0:m.message)||m})`)}const r=Te(t.title||""),o=a?await Be(a,r):await Ut(r,n),i=s.filter((m,jt)=>jt%10===0);h(`(${t.id}) 도파민 샘플 ${i.length}개`);let l=[];try{l=await Ae(i,h)}catch{}(!Array.isArray(l)||!l.length)&&(l=i.map(m=>({sentence:m,level:Me(m),reason:"heuristic"})));const c={...t};c.dopamine_graph=l,c.analysis_transcript_len=n.length,c.transcript_text=n;const u=De(o),{ko:y,en:v,zh:f}=u.keywords||{ko:[],en:[],zh:[]};c.material=u.material||c.material;const b=u.categories||{},C=Array.isArray(b.kr)?b.kr:[];c.kr_category_large=C[0]||c.kr_category_large,c.kr_category_medium=C[1]||c.kr_category_medium,c.kr_category_small=C[2]||c.kr_category_small;const U=Array.isArray(b.en)?b.en:[];c.en_category_main=U[0]||c.en_category_main,c.en_category_sub=U[1]||c.en_category_sub,c.en_micro_topic=U[2]||c.en_micro_topic;const H=Array.isArray(b.cn)?b.cn:[];return c.cn_category_large=H[0]||c.cn_category_large,c.cn_category_medium=H[1]||c.cn_category_medium,c.cn_category_small=H[2]||c.cn_category_small,c.hooking=u.hooking||c.hooking,c.narrative_structure=u.narrative||c.narrative_structure||"없음",y.length||v.length||f.length?h(`(${t.id}) 키워드 추출 완료 — KO:${y.length}, EN:${v.length}, ZH:${f.length}`):h(`(${t.id}) 키워드 결과가 비어 있습니다 (파싱 확인 필요)`),c.keywords_ko=y,c.keywords_en=v,c.keywords_zh=f,c.material||(c.material=Pe(c,n,"",s)||""),{updated:c,raw:{categoriesText,analysisText,dopamineGraph:l,transcript:n}}}function Te(t){return`아래 제공된 "제목"과 "자막"을 분석하여 JSON만 출력하세요. 다른 설명/머리말/코드펜스 금지.
형식: {"material":"...","categories":{"kr":["대","중","소"],"en":["Main","Sub","Micro"],"cn":["大","中","小"]},"keywords":{"ko":[".."],"en":[".."],"zh":[".."]},"hooking":"...","narrative":"기:.. | 승:.. | 전:.. | 결:.."}
제목: ${t}
자막은 캐시에 있습니다. 핵심만 간결히 요약해 JSON 값으로 채우세요.`}function De(t){try{const e=String(t||"").match(/\{[\s\S]*\}/);if(!e)return{};const n=JSON.parse(e[0]),s=a=>Array.isArray(a)?a.map(r=>String(r).trim()).filter(Boolean):[];if(n!=null&&n.keywords&&(n.keywords.ko=s(n.keywords.ko),n.keywords.en=s(n.keywords.en),n.keywords.zh=s(n.keywords.zh||n.keywords.cn)),n!=null&&n.categories){const a=n.categories;a.kr=s(a.kr),a.en=s(a.en),a.cn=s(a.cn)}return n.material=String(n.material||"").slice(0,120),n.hooking=String(n.hooking||"").slice(0,160),n.narrative=String(n.narrative||"").slice(0,220),n}catch{return{}}}function Me(t){const e=String(t||"").toLowerCase(),n=["충격","반전","경악","미친","대폭","폭로","소름","!","?"];let s=3;for(const a of n)if(e.includes(a)){s+=5;break}return s=Math.max(1,Math.min(10,s)),s}function Pe(t,e,n,s){const a=[t.kr_category_small,t.kr_category_medium,t.kr_category_large,t.en_micro_topic,t.en_category_main].filter(Boolean);if(a.length)return String(a[0]).slice(0,60);const r=Array.isArray(s)&&s[0]?s[0]:(e||"").split(/\n+/)[0];return String(r||"").slice(0,60)}async function W(t){L.style.display="block",L.style.color="",L.textContent=`분석 시작... (총 ${t.length}개)`,Ot(`총 ${t.length}개 분석 시작`);let e=0,n=0;for(const s of t)try{const a=g(d,"videos",s),r=await nt(a);if(!r.exists()){n++;continue}const o={id:s,...r.data()};if(o.analysis_full&&Array.isArray(o.keywords_ko)&&o.keywords_ko.length&&Array.isArray(o.dopamine_graph)&&o.dopamine_graph.length){h(`(${s}) 이미 분석됨 — 스킵`),e++,z(e,t.length,`스킵: ${o.title||s}`);continue}h(`(${s}) 분석 시작`);const{updated:i}=await Le(o),l={...i};delete l.id,await E(a,l),e++,L.textContent=`진행중... ${e}/${t.length} 완료`,z(e,t.length,`마지막 완료: ${o.title||s}`),h(`(${s}) 저장 완료`)}catch(a){console.error("분석 실패",s,a),n++,h(`(${s}) 오류: ${a.message||a}`)}L.style.color=n?"orange":"green",L.textContent=`분석 완료: 성공 ${e}, 실패 ${n}`,z(t.length,t.length,`성공 ${e}, 실패 ${n}`),await R()}lt&&lt.addEventListener("click",async()=>{const t=Array.from(document.querySelectorAll(".row-checkbox:checked")).map(e=>e.dataset.id);if(t.length===0){alert("분석할 항목을 선택하세요.");return}await W(t)});dt&&dt.addEventListener("click",async()=>{const t=q.map(n=>n.id);if(t.length===0){alert("분석할 데이터가 없습니다.");return}confirm(`전체 ${t.length}개 항목에 대해 분석을 실행할까요? 비용이 발생할 수 있습니다.`)&&await W(t)});function Ne(){try{return(localStorage.getItem("youtube_api_keys_list")||"").split(/\r?\n/).map(e=>e.trim()).filter(Boolean)}catch{return[]}}function Re(t,e){return t.length?t[e%t.length]:""}function Oe(t){try{const e=new URL(t);return e.hostname.includes("youtu.be")?e.pathname.split("/").pop():e.searchParams.get("v")?e.searchParams.get("v"):e.pathname.includes("/shorts/")?e.pathname.split("/").pop():""}catch{return""}}async function Ue(t,e,n){var l,c;const s=[];let a="",r=0,o=0;const i=Math.max(3,n.length*3);for(;s.length<e;){const u=Re(n,r++);if(!u)throw new Error("YouTube API 키가 설정되지 않았습니다. 설정 탭에서 키를 저장하세요.");const y=e-s.length,v=Math.max(1,Math.min(100,y)),f=new URL("https://www.googleapis.com/youtube/v3/commentThreads");f.searchParams.set("part","snippet,replies"),f.searchParams.set("videoId",t),f.searchParams.set("maxResults",String(v)),f.searchParams.set("order","relevance"),f.searchParams.set("key",u),a&&f.searchParams.set("pageToken",a);const b=await fetch(f.toString());if(!b.ok){if(o++,o>=i)throw new Error("YouTube API 오류 반복: "+b.status);continue}const C=await b.json();o=0;const U=Array.isArray(C.items)?C.items:[];for(const H of U)try{const m=(c=(l=H.snippet)==null?void 0:l.topLevelComment)==null?void 0:c.snippet;if(!m)continue;if(s.push({author:m.authorDisplayName||"",text:m.textDisplay||m.textOriginal||"",likeCount:Number(m.likeCount||0),publishedAt:m.publishedAt||"",updatedAt:m.updatedAt||"",authorProfileImageUrl:m.authorProfileImageUrl||"",authorChannelUrl:m.authorChannelUrl||""}),s.length>=e)break}catch{}if(s.length>=e||(a=C.nextPageToken||"",!a))break}return s}function He(t,e=10){const n=Array.isArray(t)?t.slice():[];return n.sort((s,a)=>Number(a.likeCount||0)-Number(s.likeCount||0)),n.slice(0,Math.max(1,e))}async function je(t){if(!x)return;x.style.display="block",x.style.color="";const e=Math.max(1,Math.min(1e3,Number((Z==null?void 0:Z.value)||50))),n=Ne();if(!n.length){x.textContent="YouTube API 키가 없습니다. 설정 탭에서 저장하세요.";return}x.textContent=`댓글 수집 시작... (총 ${t.length}개, 각 ${e}개)`,Ot(`댓글 수집: 총 ${t.length}개 대상`);let s=0,a=0;for(const r of t)try{const o=g(d,"videos",r),i=await nt(o);if(!i.exists()){a++;continue}const l={id:r,...i.data()},c=Oe(l.youtube_url||"");if(!c){a++,h(`(${r}) YouTube ID 파싱 실패`);continue}h(`(${r}) 댓글 수집 시작 (최대 ${e}개)`);const u=await Ue(c,e,n);h(`(${r}) 댓글 수집 완료 ${u.length}개`);const y=He(u,20),v={comments_fetched_at:Date.now(),comments_total:u.length,comments_top:y};await E(o,v),s++,z(s,t.length,`댓글 완료: ${l.title||r}`)}catch(o){a++,h(`(${r}) 댓글 오류: ${o.message||o}`)}x.style.color=a?"orange":"green",x.textContent=`댓글 수집 완료: 성공 ${s}, 실패 ${a}`,await R()}ut&&ut.addEventListener("click",async()=>{const t=Array.from(document.querySelectorAll(".row-checkbox:checked")).map(e=>e.dataset.id);if(t.length===0){alert("댓글을 수집할 항목을 선택하세요.");return}await je(t)});function Ht(t){if(t){const e=["csv","xlsx"],n=t.name.split(".").pop().toLowerCase();e.includes(n)?(A=t,T.textContent=`선택된 파일: ${t.name}`,T.classList.add("active")):(alert("CSV 또는 XLSX 파일만 업로드할 수 있습니다."),A=null,T.textContent="",T.classList.remove("active"))}}it.addEventListener("change",()=>Ht(it.files[0]));["dragenter","dragover","dragleave","drop"].forEach(t=>{N.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation()})});["dragenter","dragover"].forEach(t=>{N.addEventListener(t,()=>N.classList.add("dragover"))});["dragleave","drop"].forEach(t=>{N.addEventListener(t,()=>N.classList.remove("dragover"))});N.addEventListener("drop",t=>Ht(t.dataTransfer.files[0]));re.addEventListener("click",()=>{if(!A){k.textContent="CSV 또는 XLSX 파일을 선택해주세요.",k.style.color="red";return}k.textContent="파일 처리 중...";const t=A.name.split(".").pop().toLowerCase();if(t==="csv")Papa.parse(A,{header:!0,skipEmptyLines:!0,complete:e=>_t(e.data),error:e=>{k.textContent=`CSV 파싱 오류: ${e.message}`}});else if(t==="xlsx"){const e=new FileReader;e.onload=n=>{const s=XLSX.read(n.target.result,{type:"array"}),a=XLSX.utils.sheet_to_json(s.Sheets[s.SheetNames[0]]);_t(a)},e.readAsArrayBuffer(A)}});async function _t(t){k.textContent="변경사항 분석 중...";const e=new Map;try{(await K(B(d,"videos"))).docs.forEach(i=>{var c;const l=(c=i.data())==null?void 0:c.hash;l&&e.set(l,i.id)})}catch(o){console.error("기존 데이터 로드 실패",o)}const n=[],s=[];t.forEach(o=>{if(!o.Title||!o["YouTube URL"])return;const i=String(o.Hash||qe(String(o["YouTube URL"]||o.Title))).trim(),l={thumbnail:o.Thumbnail||"",title:o.Title||"",views:o.Views||"",views_numeric:Number(o.Views_numeric)||0,channel:o.Channel||"",date:o.Date||"",subscribers:o.Subscribers||"",subscribers_numeric:Number(o.Subscribers_numeric)||0,hash:i,youtube_url:o["YouTube URL"]||"",group_name:o.group_name||"",template_type:o["템플릿 유형"]||"",last_modified:Date.now()};e.has(i)?s.push({id:e.get(i),data:l}):n.push({id:i,data:l})}),k.textContent=`신규 ${n.length}개, 업데이트 ${s.length}개 처리 중...`;const a=500;let r=0;for(let o=0;o<n.length;o+=a){const i=_(d),l=n.slice(o,o+a);l.forEach(c=>{i.set(g(d,"videos",c.id),c.data)}),await i.commit(),r+=l.length,k.textContent=`처리 중(신규): ${r}/${n.length+s.length}`}for(let o=0;o<s.length;o+=a){const i=_(d),l=s.slice(o,o+a);l.forEach(c=>{i.update(g(d,"videos",c.id),c.data)}),await i.commit(),r+=l.length,k.textContent=`처리 중(업데이트): ${r}/${n.length+s.length}`}k.textContent=`완료: 신규 ${n.length}, 업데이트 ${s.length}`,k.style.color="green";try{const i=(await K(B(d,"videos"))).docs.map(y=>({id:y.id,...y.data()})),l=new Blob([JSON.stringify(i)],{type:"application/json"}),c=Zt(ne,"public/videos.json");await Qt(c,l,{contentType:"application/json"});const u=await te(c);console.log("정적 JSON 업로드 완료:",u);try{await E(g(d,"system","settings"),{lastBuild:Date.now(),videosJsonUrl:u})}catch{}}catch(o){console.warn("정적 JSON 업로드 실패(무시 가능):",(o==null?void 0:o.message)||o)}A=null,T.textContent="",T.classList.remove("active"),R()}function qe(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0;return Math.abs(e).toString(36)}
