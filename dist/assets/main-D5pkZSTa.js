import"./style-HOslubru.js";import{initializeApp as dt}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore as lt,getDoc as ut,doc as ht,query as H,collection as V,orderBy as z,limit as j,getDocs as O,startAfter as mt,where as pt}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{f as ft}from"./firebase-config-D0anIP3T.js";const gt=dt(ft),k=lt(gt),E=document.getElementById("video-table-container");let h=document.getElementById("video-table-body");const _=document.getElementById("pagination-container"),S=document.getElementById("searchInput"),I=document.getElementById("form-type-filter"),T=document.getElementById("start-date-filter"),A=document.getElementById("end-date-filter"),F=document.getElementById("sort-filter"),U=document.querySelectorAll(".view-chip-group .chip"),Y=document.querySelectorAll(".sort-chip-group .chip"),G=document.getElementById("stat-channels"),K=document.getElementById("stat-videos"),Q=document.getElementById("stat-avg-rise"),W=document.getElementById("stat-updated"),X=document.getElementById("stat-channels-sub"),Z=document.getElementById("stat-videos-sub"),tt=document.getElementById("toggle-stats-chip"),et=document.getElementById("stats-grid"),D=document.getElementById("page-size-select"),$=document.getElementById("load-more-btn");let l=[],r=[],d=1,m=100,q="video",v="pct_desc",R=null,C=!0;const bt=60*60*1e3,vt="videosCacheDB",w="kv",nt="videosCompressed";async function st(){return new Promise((t,s)=>{const n=indexedDB.open(vt,1);n.onupgradeneeded=()=>{const i=n.result;i.objectStoreNames.contains(w)||i.createObjectStore(w)},n.onsuccess=()=>t(n.result),n.onerror=()=>s(n.error)})}async function wt(t){try{const s=await st();return new Promise((n,i)=>{const o=s.transaction(w,"readonly").objectStore(w).get(t);o.onsuccess=()=>n(o.result||null),o.onerror=()=>i(o.error)})}catch{return null}}async function yt(t,s){try{const n=await st();return new Promise((i,a)=>{const c=n.transaction(w,"readwrite").objectStore(w).put(s,t);c.onsuccess=()=>i(!0),c.onerror=()=>a(c.error)})}catch{return!1}}async function _t(t){const s=JSON.stringify(t);if("CompressionStream"in window){const n=new CompressionStream("gzip"),a=new Blob([s]).stream().pipeThrough(n),e=await new Response(a).arrayBuffer();return{ts:Date.now(),algo:"gzip",buffer:e}}return{ts:Date.now(),algo:"none",text:s}}async function Et(t){if(!t)return null;if(t.algo==="gzip"&&"DecompressionStream"in window){const s=new DecompressionStream("gzip"),n=new Blob([t.buffer]).stream().pipeThrough(s),i=await new Response(n).text();return{ts:t.ts,data:JSON.parse(i)}}return t.text?{ts:t.ts,data:JSON.parse(t.text)}:null}function f(t){if(typeof t=="number")return t;const n=String(t||"").replace(/[^0-9]/g,"");return n?Number(n):0}function J(t){const s=f(t.views_numeric||t.views||0),n=f(t.views_prev_numeric||t.views_baseline_numeric||t.views||0)||s;return n?(s-n)/n*100:0}function Bt(t){const s=f(t.views_numeric||t.views||0)||0,n=f(t.views_prev_numeric||t.views_baseline_numeric||t.views||0)||s;return Math.max(0,s-n)}function b(t){try{return Number(t||0).toLocaleString()}catch{return String(t)}}function at(t,s){t.forEach(n=>n.classList.remove("chip-active")),s&&s.classList.add("chip-active")}function M(t){E&&(t==="channel"?E.innerHTML=`
        <table class="data-table">
            <thead>
                <tr>
                    <th>#</th><th>대표 썸네일</th><th>채널</th><th>영상 수</th>
                    <th>총 상승 조회수</th><th>평균 증가율</th><th>대표 영상</th>
                </tr>
            </thead>
            <tbody id="video-table-body"></tbody>
        </table>`:E.innerHTML=`
        <table class="data-table" aria-describedby="stat-updated">
            <thead>
                <tr>
                    <th>#</th>
                    <th>썸네일</th>
                    <th>제목</th>
                    <th>채널</th>
                    <th>현재 조회수</th>
                    <th>기준</th>
                    <th>증가수</th>
                    <th>증가율</th>
                    <th>업데이트</th>
                    <th>링크</th>
                </tr>
            </thead>
            <tbody id="video-table-body"></tbody>
        </table>`,h=document.getElementById("video-table-body"))}function Ct(t){try{const s=new Set(t.map(a=>(a.channel||"").trim()).filter(Boolean)),n=t.length?t.map(J).reduce((a,e)=>a+e,0)/t.length:0,i=Math.max(...t.map(a=>Number(a.views_last_checked_at||0)).filter(Boolean),0);G&&(G.textContent=b(s.size)),K&&(K.textContent=b(t.length)),Q&&(Q.textContent=`${n>=0?"+":""}${n.toFixed(2)}%`),W&&(W.textContent=i?new Date(i).toLocaleString():"-"),X&&(X.textContent="고유 채널 수"),Z&&(Z.textContent="필터 적용됨")}catch{}}async function xt(){const t=await wt(nt),s=await Et(t);return s?{timestamp:s.ts,data:s.data}:null}async function B(t){const s=await _t(t);await yt(nt,s)}async function Lt(){var t;try{h&&(h.innerHTML='<tr><td colspan="9" class="info-message">데이터를 불러오는 중...</td></tr>');try{const a=await fetch("/public/videos.json",{cache:"no-cache"});if(a.ok){l=await a.json(),await B(l),p();return}}catch{}try{const a=await ut(ht(k,"system","settings"));if(a.exists()){const e=((t=a.data())==null?void 0:t.videosJsonUrl)||"";if(e){const o=await fetch(e,{cache:"no-cache"});if(o.ok){l=await o.json(),await B(l),p();return}}}}catch{}const s=await xt();if(s&&Date.now()-s.timestamp<bt){l=s.data||[],p(),St(s.timestamp).catch(()=>{});return}const n=H(V(k,"videos"),z("date","desc"),j(m)),i=await O(n);l=i.docs.map(a=>({id:a.id,...a.data()})),R=i.docs[i.docs.length-1],C=i.docs.length===m,await B(l),p(),ot()}catch(s){console.error("Error fetching videos: ",s),M("video"),h&&(h.innerHTML='<tr><td colspan="9" class="error-message">데이터를 불러오는 데 실패했습니다. Firebase 설정을 확인해주세요.</td></tr>')}}async function it(){if(!C||!R)return;const t=H(V(k,"videos"),z("date","desc"),mt(R),j(m)),s=await O(t),n=s.docs.map(i=>({id:i.id,...i.data()}));l=[...l,...n],R=s.docs[s.docs.length-1],C=s.docs.length===m,await B(l),p(),ot()}async function St(t){try{const s=H(V(k,"videos"),pt("last_modified",">",t||0),z("last_modified","desc"),j(50)),n=await O(s);if(!n.size)return;const i=n.docs.map(e=>({id:e.id,...e.data()})),a=new Map(l.map(e=>[e.id,e]));i.forEach(e=>a.set(e.id,e)),l=Array.from(a.values()),await B(l),p()}catch{}}function ot(){$&&($.style.display=C?"inline-block":"none")}function p(){r=[...l];const t=((S==null?void 0:S.value)||"").toLowerCase();t&&(r=r.filter(a=>[a.title,a.channel,a.kr_category_large,a.kr_category_medium,a.kr_category_small,a.material,a.template_type,a.group_name,a.source_type,a.hooking,a.narrative_structure].some(o=>o&&String(o).toLowerCase().includes(t))));const s=(I==null?void 0:I.value)||"all";s!=="all"&&(r=r.filter(a=>a.group_name===s));const n=(T==null?void 0:T.value)||"",i=(A==null?void 0:A.value)||"";n&&(r=r.filter(a=>a.date&&a.date>=n)),i&&(r=r.filter(a=>a.date&&a.date<=i)),d=1,Ct(r),y()}function y(){q==="channel"?Tt():It(),P()}function It(){if(M("video"),!h)return;let t=r.slice();t.forEach(e=>{e._pct=J(e),e._riseAbs=Bt(e)}),t.sort((e,o)=>{if(v==="pct_desc")return o._pct-e._pct||o._riseAbs-e._riseAbs;if(v==="abs_desc")return o._riseAbs-e._riseAbs||o._pct-e._pct;const c=e.date?new Date(e.date).getTime():0;return(o.date?new Date(o.date).getTime():0)-c});const s=(d-1)*m,n=s+m,i=t.slice(s,n);if(!i.length){h.innerHTML='<tr><td colspan="9" class="info-message">조건에 맞는 항목이 없습니다.</td></tr>';return}const a=i.map((e,o)=>{const c=f(e.views_numeric||e.views||0),u=f(e.views_prev_numeric||e.views_baseline_numeric||e.views||0)||c,g=u?(c-u)/u*100:0,x=g>=0?"#16a34a":"#dc2626",L=e.thumbnail?`<img src="${e.thumbnail}" class="table-thumbnail" loading="lazy" onerror="this.outerHTML='<div class=\\'no-thumbnail-placeholder\\'>이미지 없음</div>'">`:'<div class="no-thumbnail-placeholder">이미지 없음</div>',rt=e.views_last_checked_at?new Date(e.views_last_checked_at).toLocaleString():"-";return`
        <tr>
            <td>${s+o+1}</td>
            <td>${L}</td>
            <td class="table-title"><a href="details.html?id=${e.id}" target="_blank">${e.title||""}</a></td>
            <td>${e.channel||""}</td>
            <td>${b(c)}</td>
            <td>${b(u)}</td>
            <td>${b(c-u)}</td>
            <td style="color:${x}">${(g>=0?"+":"")+g.toFixed(2)}%</td>
            <td>${rt}</td>
            <td><a class="btn btn-details" href="${e.youtube_url||"#"}" target="_blank">YouTube</a></td>
        </tr>`}).join("");h.innerHTML=a}function ct(t){const s=new Map;for(const n of t){const i=(n.channel||"").trim()||"Unknown";s.has(i)||s.set(i,{channel:i,videos:[],totalRiseAbs:0,avgRisePct:0,representative:null});const a=s.get(i),e=f(n.views_numeric||n.views||0)||0,o=f(n.views_prev_numeric||n.views_baseline_numeric||n.views||0)||e,c=Math.max(0,e-o);if(a.videos.push(n),a.totalRiseAbs+=c,!a.representative)a.representative=n;else{const u=n.date?new Date(n.date).getTime():0,g=a.representative.date?new Date(a.representative.date).getTime():0;u>g&&(a.representative=n)}}for(const n of s.values()){const i=n.videos.map(a=>J(a));n.avgRisePct=i.length?i.reduce((a,e)=>a+e,0)/i.length:0}return Array.from(s.values())}function Tt(){if(M("channel"),!h)return;let t=ct(r);t.sort((e,o)=>v==="pct_desc"?o.avgRisePct-e.avgRisePct||o.totalRiseAbs-e.totalRiseAbs:o.totalRiseAbs-e.totalRiseAbs||o.avgRisePct-e.avgRisePct);const s=(d-1)*m,n=s+m,i=t.slice(s,n);if(!i.length){h.innerHTML='<tr><td colspan="7" class="info-message">조건에 맞는 항목이 없습니다.</td></tr>';return}const a=i.map((e,o)=>{var x,L;const c=(x=e.representative)!=null&&x.thumbnail?`<img src="${e.representative.thumbnail}" class="table-thumbnail" loading="lazy" onerror="this.outerHTML='<div class=\\'no-thumbnail-placeholder\\'>이미지 없음</div>'">`:'<div class="no-thumbnail-placeholder">이미지 없음</div>',u=((L=e.representative)==null?void 0:L.id)||"",g=u?`details.html?id=${encodeURIComponent(u)}`:"#";return`
        <tr>
            <td>${s+o+1}</td>
            <td>${c}</td>
            <td class="table-title">${e.channel}</td>
            <td>${e.videos.length}</td>
            <td>${b(e.totalRiseAbs)}</td>
            <td style="color:${e.avgRisePct>=0?"#16a34a":"#dc2626"}">${(e.avgRisePct>=0?"+":"")+e.avgRisePct.toFixed(2)}%</td>
            <td><a class="btn btn-details" href="${g}" target="_blank">자세히</a></td>
        </tr>`}).join("");h.innerHTML=a}function At(){if(q==="channel"){const t=ct(r);return Math.max(1,Math.ceil(t.length/m))}return Math.max(1,Math.ceil(r.length/m))}function P(){if(!_)return;_.innerHTML="";const t=At();if(t<=1)return;const s=e=>{d=e,y(),E&&E.scrollIntoView({behavior:"smooth",block:"start"})},n=document.createElement("button");n.textContent="이전",n.className="pagination-btn",n.disabled=d===1,n.addEventListener("click",()=>d>1&&s(d-1));const i=document.createElement("button");i.textContent="다음",i.className="pagination-btn",i.disabled=d===t,i.addEventListener("click",()=>d<t&&s(d+1));const a=document.createElement("span");a.className="page-info",a.textContent=`${d} / ${t}`,_.appendChild(n),_.appendChild(a),_.appendChild(i)}[S,I,T,A].forEach(t=>{t&&(t.addEventListener("input",p),(t.tagName==="SELECT"||t.type==="date")&&t.addEventListener("change",p))});U.forEach(t=>{t.addEventListener("click",()=>{at(U,t),q=t.getAttribute("data-view")||"video",d=1,y(),P()})});Y.forEach(t=>{t.addEventListener("click",()=>{at(Y,t),v=t.getAttribute("data-sort")||"pct_desc",d=1,y(),P()})});F&&F.addEventListener("change",()=>{v==="date_desc"&&y()});M("video");Lt();tt&&et&&tt.addEventListener("click",()=>{et.classList.toggle("hidden")});D&&D.addEventListener("change",()=>{const t=Number(D.value||100);m=isFinite(t)&&t>0?t:100,d=1,y(),P()});$&&$.addEventListener("click",()=>{it()});let N=!1;window.addEventListener("scroll",async()=>{if(N)return;if(window.innerHeight+window.scrollY>=document.body.offsetHeight-200&&C){N=!0;try{await it()}finally{N=!1}}});
