<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>콘텐츠 관리자</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="login-view">
        <div class="login-box">
            <h2>관리자 로그인</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">이메일</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">비밀번호</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary full-width">로그인</button>
                <p id="login-error" class="error-message" style="margin-top: 1rem; text-align: center;"></p>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <div class="container">
            <header class="admin-header">
                <h2>콘텐츠 관리 대시보드</h2>
                <button id="logout-btn" class="btn btn-danger">로그아웃</button>
            </header>
            <div id="analysis-banner" class="sticky-banner hidden">
                <div class="banner-row">
                    <strong>분석 현황</strong>
                    <span id="analysis-banner-text"></span>
                </div>
                <div id="analysis-progress" class="progress">
                    <div id="analysis-progress-bar" class="progress-bar" style="width:0%"></div>
                </div>
                <pre id="analysis-log" class="analysis-log"></pre>
            </div>
            
            <div class="tabs">
                <button class="tab-link active" data-tab="data-management">데이터 관리</button>
                <button class="tab-link" data-tab="upload-data">데이터 업로드</button>
                <button class="tab-link" data-tab="settings">설정</button>
            </div>

            <div id="data-management" class="tab-content active">
                <div class="data-toolbar">
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <button id="bulk-delete-btn" class="btn btn-danger">선택 삭제</button>
                        <button id="run-analysis-selected-btn" class="btn btn-primary">선택 분석 실행 (Gemini)</button>
                        <button id="run-analysis-all-btn" class="btn btn-primary">전체 분석 실행 (Gemini)</button>
                    </div>
                    <input type="text" id="data-search-input" placeholder="제목, 채널명 등으로 검색...">
                </div>
                <div id="data-table-container">
                    </div>
                <p id="analysis-status" class="info-message" style="display:none"></p>
            </div>

            <div id="upload-data" class="tab-content">
                <div class="upload-box">
                    <h2>데이터 업로드</h2>
                    <p>CSV 또는 XLSX 파일을 드래그하거나 선택하여 데이터를 추가/업데이트하세요.</p>
                    <div id="file-drop-area">
                        <label for="file-input" class="file-drop-label">
                            <span class="file-button">
                                <span class="file-icons">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="M12 12v9"></path><path d="m16 16-4-4-4 4"></path></svg>
                                </span>
                                파일 선택하기
                            </span>
                            <span class="drop-message">또는 파일을 여기로 드래그하세요</span>
                        </label>
                        <input type="file" id="file-input" accept=".csv, .xlsx" hidden>
                    </div>
                    <div id="file-name-display"></div>
                    <button id="upload-btn" class="btn btn-primary full-width">업로드</button>
                    <p id="upload-status" style="margin-top: 1rem; text-align: center;"></p>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div class="upload-box">
                    <h2>제미나이 API 설정</h2>
                    <p>관리자 브라우저에 안전하게 저장됩니다. 키를 입력하면 자동분석에 사용됩니다.</p>
                    <div class="form-group">
                        <label for="gemini-api-key">Gemini API Key</label>
                        <input type="password" id="gemini-api-key" placeholder="AIza...">
                    </div>
                    <div class="form-group">
                        <button id="save-gemini-key-btn" class="btn btn-primary">저장</button>
                        <button id="test-gemini-key-btn" class="btn">키 테스트</button>
                    </div>
                    <p id="gemini-key-status" class="info-message" style="margin-top: 1rem; text-align: left;"></p>
                    <hr style="margin:1.5rem 0; border:0; border-top:1px solid var(--border-color);">
                    <h3 style="margin-bottom:0.5rem;">자막 추출 서버 상태</h3>
                    <p>로컬 자막 서버를 실행해야 자막을 가져올 수 있습니다. (선택) Node/yt-dlp 서버 또는 (권장) Python <code>api/transcript.py</code> 서버를 실행하세요. 개발용 기본 주소는 <code>http://localhost:8787</code> 입니다.</p>
                    <div class="form-group">
                        <label for="transcript-server-url">서버 주소</label>
                        <input type="text" id="transcript-server-url" placeholder="http://localhost:8787" />
                    </div>
                    <button id="save-transcript-server-btn" class="btn">서버 주소 저장</button>
                    <p id="transcript-server-status" class="info-message" style="margin-top: 1rem; text-align: left;"></p>
                </div>

                <div class="upload-box" style="margin-top: 2rem;">
                    <h2>YouTube API 키 관리</h2>
                    <p style="color: var(--text-secondary); margin-bottom: .75rem;">여러 개의 YouTube Data API 키를 줄바꿈으로 입력하세요. 랭킹 업데이트 시 라운드로빈으로 사용합니다.</p>
                    <div class="form-group">
                        <label for="youtube-api-keys">API Keys (각 줄에 1개)</label>
                        <textarea id="youtube-api-keys" style="min-height:120px; width:100%;"></textarea>
                    </div>
                    <div class="form-group">
                        <button id="save-youtube-keys-btn" class="btn btn-primary">저장</button>
                        <button id="test-youtube-keys-btn" class="btn">키 테스트</button>
                    </div>
                    <p id="youtube-keys-status" class="info-message" style="margin-top: 1rem; text-align: left;"></p>
                </div>

                <div class="upload-box" style="margin-top: 2rem;">
                    <h2>예약 실행</h2>
                    <p style="color: var(--text-secondary); margin-bottom: .75rem;">지정한 시간에 선택 항목 또는 전체 영상 분석을 자동 실행합니다. (대시보드가 열려 있어야 실행됩니다)</p>
                    <div class="form-group">
                        <label>작업 유형</label>
                        <div class="inline-options">
                            <label class="option"><input type="radio" name="schedule-type" value="analysis" checked> 분석 실행</label>
                            <label class="option"><input type="radio" name="schedule-type" value="ranking"> 랭킹 업데이트</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>대상</label>
                        <div class="inline-options">
                            <label class="option"><input type="radio" name="schedule-scope" value="selected" checked> 선택 항목</label>
                            <label class="option"><input type="radio" name="schedule-scope" value="all"> 전체</label>
                        </div>
                        <div style="color:var(--text-secondary); font-size:12px;">선택 항목은 데이터 관리 탭에서 체크된 항목 기준입니다.</div>
                    </div>
                    <div class="form-group">
                        <label for="schedule-time">실행 시각</label>
                        <input type="datetime-local" id="schedule-time">
                    </div>
                    <div style="display:flex; gap:.5rem; align-items:center;">
                        <button id="schedule-create-btn" class="btn btn-primary">예약 등록</button>
                        <button id="schedule-ranking-btn" class="btn">랭킹 예약(전체)</button>
                    </div>
                    <p id="schedule-create-status" class="info-message" style="margin-top: 1rem; text-align: left;"></p>

                    <h3 style="margin:1.5rem 0 .5rem;">예약 목록</h3>
                    <div id="schedules-table-container"></div>
                    <h3 style="margin:1.5rem 0 .5rem;">예약 실행 로그</h3>
                    <pre id="schedule-log" class="analysis-log"></pre>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <header class="modal-header">
                <h2 class="modal-title">데이터 수정</h2>
                <button id="close-edit-modal-btn" class="close-btn">&times;</button>
            </header>
            <form id="edit-form"></form>
            <div class="modal-actions">
                <button id="cancel-edit-btn" class="btn btn-danger">취소</button>
                <button id="save-edit-btn" class="btn btn-primary">저장</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content small">
            <h2 id="confirm-modal-title">삭제 확인</h2>
            <p id="confirm-modal-message">정말로 삭제하시겠습니까?</p>
            <div class="modal-actions">
                <button id="cancel-delete-btn" class="btn btn-danger">취소</button>
                <button id="confirm-delete-btn" class="btn btn-primary">삭제</button>
            </div>
        </div>
    </div>
    
    <script type="module" src="./scripts/admin.js"></script>
</body>
</html>

